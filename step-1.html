<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
  <title>WebRTC Practice</title>
</head>

<body class="bg-gray-50 dark:bg-gray-950">
  <header>
    <nav
      class="flex items-center justify-between w-full relative max-w-2xl border-gray-200 dark:border-gray-700 mx-auto pt-8 pb-8 sm:pb-16 text-gray-900 bg-gray-50 dark:bg-gray-950 bg-opacity-60 dark:text-gray-100">
      <div class="flex justify-center items-center gap-3">
        <a href="step-1.html"
          class="cursor-pointer font-normal text-gray-600 dark:text-gray-400 rounded-lg hover:text-gray-950 dark:hover:text-gray-200 transition-all">
          <span class="capsize">Step-1</span>
        </a>
        <a href="step-2.html"
          class="cursor-pointer font-normal text-gray-600 dark:text-gray-400 rounded-lg hover:text-gray-950 dark:hover:text-gray-200 transition-all">
          <span class="capsize">Step-2</span>
        </a>
        <a href="step-3.html"
          class="cursor-pointer font-normal text-gray-600 dark:text-gray-400 rounded-lg hover:text-gray-950 dark:hover:text-gray-200 transition-all">
          <span class="capsize">Step-3</span>
        </a>
        <a href="step-6.html"
          class="cursor-pointer font-normal text-gray-600 dark:text-gray-400 rounded-lg hover:text-gray-950 dark:hover:text-gray-200 transition-all">
          <span class="capsize">Step-6</span>
        </a>
        <a href="step-7.html"
          class="cursor-pointer font-normal text-gray-600 dark:text-gray-400 rounded-lg hover:text-gray-950 dark:hover:text-gray-200 transition-all">
          <span class="capsize">Step-7</span>
        </a>
        <a href="step-8.html"
          class="cursor-pointer font-normal text-gray-600 dark:text-gray-400 rounded-lg hover:text-gray-950 dark:hover:text-gray-200 transition-all">
          <span class="capsize">Step-8</span>
        </a>
        <a href="step-9.html"
          class="cursor-pointer font-normal text-gray-600 dark:text-gray-400 rounded-lg hover:text-gray-950 dark:hover:text-gray-200 transition-all">
          <span class="capsize">Step-9</span>
        </a>
        <a href="step-10.html"
          class="cursor-pointer font-normal text-gray-600 dark:text-gray-400 rounded-lg hover:text-gray-950 dark:hover:text-gray-200 transition-all">
          <span class="capsize">Step-10</span>
        </a>
      </div>
    </nav>
  </header>

  <main class="flex flex-col justify-center items-center">
    <div id="video-streams" class="flex justify-center"></div>
  </main>

  <div class="">
    <div class="p-3 flex justify-center">
      <button id="open-webcam-button"
        class="cursor-pointer font-normal text-gray-600 dark:text-gray-400 rounded-lg hover:text-gray-950 dark:hover:text-gray-200 transition-all">
        <span class="capsize">Open WebCam</span>
      </button>
      <button type="button" id="mute-button"
        class="cursor-pointer px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-500 focus:ring-4 focus:ring-indigo-500">Mute</button>
    </div>
  </div>
</body>

<script>
  // Step 1: Understanding WebRTC Basics
  const openWebCamButton = document.getElementById("open-webcam-button");
  const streamsElement = document.getElementById("video-streams");
  const muteButton = document.getElementById("mute-button");
  let videoElement = null;
  let videoStream = null;

  openWebCamButton.addEventListener("click", () => {
    if (videoElement) {
      videoStream.getTracks().forEach(track => track.stop())
      videoStream = null;
      videoElement.remove();
      videoElement = null;
      openWebCamButton.innerText = "Open WebCam";
    } else {
      navigator.mediaDevices.getUserMedia({
          video: true,
          audio: true
        })
        .then((stream) => {
          videoStream = stream;
          videoElement = document.createElement("video");
          videoElement.id = "my-video-stream";
          videoElement.srcObject = stream;
          videoElement.autoplay = true;
          videoElement.controls = true;
          // videoElement.muted = true;
          streamsElement.appendChild(videoElement);
          openWebCamButton.innerText = "Close WebCam";
        })
        .catch((error) => {
          console.error("Error accessing media devices:", error);
          // alert("Error accessing media devices: " + error.message);
          // retry for permission
          checkPermissions();
        });
    }
  })

  muteButton.addEventListener("click", () => {
    videoElement.muted = !videoElement.muted;
    if (videoElement.muted) {
      muteButton.classList.add("line-through");
    } else {
      muteButton.classList.remove("line-through");
    }
  });

  async function checkPermissions() {
    try {
      const cameraPermission = await navigator.permissions.query({
        name: 'camera'
      });
      const microphonePermission = await navigator.permissions.query({
        name: 'microphone'
      });

      console.log('Camera permission state:', cameraPermission.state);
      console.log('Microphone permission state:', microphonePermission.state);

      if (cameraPermission.state === 'granted' && microphonePermission.state === 'granted') {
        console.log('Permissions are granted. Retrying getUserMedia...');
        requestMediaAccess();
      } else {
        alert('Permissions are not granted. Guide the user to enable them.');
      }
    } catch (error) {
      console.error('Error checking permissions:', error);
    }
  }
</script>

</html>